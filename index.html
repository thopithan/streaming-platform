<!DOCTYPE html>
<html lang="en" class="bg-gray-900 text-gray-200">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Streaming Service (Direct TMDb Fetch)</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: 'Inter', sans-serif; }
    .horizontal-scroll::-webkit-scrollbar { height: 8px; }
    .horizontal-scroll::-webkit-scrollbar-thumb { background-color: #4a5568; border-radius: 10px;}
    .hero-gradient { background: linear-gradient(to top, rgba(17,24,39,1) 5%, rgba(17,24,39,0.7) 20%, rgba(17,24,39,0) 50%); }
    .text-shadow { text-shadow: 0px 2px 4px rgba(0,0,0,0.5); }
    #passcode-section, #auth-status-container { /* Styles to center them */ }
    #app-content { display: none; }
    .view { display: none; }
    .view.active { display: block; }
    .animate-spin { animation: spin 1s linear infinite; } /* For spinner */
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
  </style>
</head>
<body class="bg-gray-900">

<!-- Passcode Section -->
<div id="passcode-section" class="fixed inset-0 z-[100] bg-gray-900 flex flex-col items-center justify-center p-8">
  <div class="bg-gray-800 p-8 rounded-xl shadow-xl border border-gray-700 w-full max-w-md">
    <h2 class="text-2xl font-bold text-white mb-6">Enter Passcode</h2>
    <input type="password" id="passcode-input-field" class="w-full bg-gray-700 text-white px-4 py-3 mb-4 border border-gray-600 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 outline-none" placeholder="Passcode" autocomplete="off">
    <button id="passcode-submit-button" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg shadow-md focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-opacity-75 transition duration-300 ease-in-out">
      Access
    </button>
    <p id="passcode-error-message" class="text-red-400 mt-3 text-sm hidden">Invalid passcode.</p>
  </div>
</div>

<!-- Google Auth Section -->
<div id="auth-status-container" class="fixed inset-0 z-[90] bg-gray-900 flex-col items-center justify-center p-8 hidden">
  <div id="auth-status" class="bg-gray-800 p-8 rounded-xl shadow-xl border border-gray-700 w-full max-w-md flex flex-col items-center">
    <p id="status-message" class="text-lg text-gray-300 mb-4">Please sign in to view your videos.</p>
    <button id="authorize_button" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg shadow-md focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-opacity-75 transition duration-300 ease-in-out" disabled>
      Sign In with Google
    </button>
    <div id="loading-spinner" class="hidden mt-4 w-12 h-12 border-4 border-gray-600 border-t-purple-500 border-solid rounded-full animate-spin"></div>
    <p id="error-message" class="text-red-400 mt-4 hidden"></p>
  </div>
</div>

<!-- Main App Content -->
<div id="app-content" class="min-h-screen">
  <!-- Navbar -->
  <nav class="fixed top-0 left-0 right-0 z-50 bg-gray-900 bg-opacity-80 backdrop-blur-md p-4 shadow-lg">
    <div class="container mx-auto flex items-center justify-between">
      <div class="text-2xl font-bold text-white">MYFLIX</div>
      <div class="hidden md:flex items-center space-x-6">
        <a href="#" class="text-gray-300 hover:text-white nav-link" data-view="dashboard-view">DASHBOARD</a>
        <!-- Category links can be added later if filtering based on TMDb genres -->
      </div>
      <div class="flex items-center space-x-4">
        <button class="text-gray-300 hover:text-white"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg></button>
        <button class="text-gray-300 hover:text-white"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg></button>
      </div>
    </div>
  </nav>

  <!-- Dashboard View / Homepage -->
  <div id="dashboard-view" class="view active pt-20">
    <section id="hero-section" class="relative h-[70vh] min-h-[400px] w-full flex items-end p-8 md:p-16 text-white">
      <div id="hero-background" class="absolute inset-0 bg-cover bg-center"></div>
      <div class="absolute inset-0 hero-gradient"></div>
      <div class="relative z-10 max-w-xl">
        <h1 id="hero-title" class="text-4xl md:text-6xl font-bold mb-4 text-shadow"></h1>
        <p id="hero-meta" class="text-lg mb-2 text-shadow"></p>
        <p id="hero-synopsis-short" class="text-md mb-6 text-shadow line-clamp-3"></p>
        <div class="flex space-x-4">
          <button id="hero-play-button" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-8 rounded-md text-lg">PLAY</button>
          <button id="hero-add-list-button" class="bg-gray-700 bg-opacity-70 hover:bg-gray-600 text-white p-3 rounded-md border border-gray-500">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
          </button>
        </div>
      </div>
    </section>
    <div id="video-categories-container" class="container mx-auto px-4 py-8 space-y-10">
      <!-- Categories will be dynamically inserted here -->
    </div>
  </div>

  <!-- Movie Detail View -->
  <div id="movie-detail-view" class="view container mx-auto px-4 py-8 pt-24 space-y-10">
    <button id="back-to-dashboard" class="mb-6 text-purple-400 hover:text-purple-300 flex items-center">
      <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
      Back to Dashboard
    </button>
    <div class="flex flex-col md:flex-row gap-8">
      <div class="md:w-1/3"><img id="detail-poster" src="" alt="Movie Poster" class="rounded-lg shadow-xl w-full"></div>
      <div class="md:w-2/3 text-gray-300">
        <h1 id="detail-title" class="text-4xl md:text-5xl font-bold text-white mb-3"></h1>
        <div id="detail-meta-info" class="flex items-center space-x-3 text-gray-400 mb-4">
          <span id="detail-year"></span><span class="detail-bullet" style="display:none;">•</span>
          <span id="detail-type"></span><span class="detail-bullet" style="display:none;">•</span>
          <span id="detail-duration"></span>
        </div>
        <p id="detail-synopsis" class="mb-6 text-lg leading-relaxed"></p>
        <button id="detail-play-button" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-10 rounded-md text-lg mb-8">PLAY VIDEO</button>
        <div class="mb-6"><h3 class="text-xl font-semibold text-white mb-2">Cast</h3><ul id="detail-cast-list" class="list-none space-y-1 text-gray-400"></ul></div>
        <div><h3 class="text-xl font-semibold text-white mb-2">Ratings</h3><div id="detail-ratings" class="flex space-x-4 text-gray-400"></div></div>
      </div>
    </div>
    <section id="detail-related-section" class="pt-10"></section>
  </div>

  <!-- Video Player Modal -->
  <div id="video-modal" class="fixed inset-0 z-[1000] hidden flex items-center justify-center bg-black bg-opacity-80 p-4">
    <div class="relative bg-gray-800 rounded-xl shadow-2xl p-1 md:p-2 w-full max-w-4xl max-h-[90vh] overflow-hidden">
      <button id="close-modal" class="absolute top-2 right-2 md:top-3 md:right-3 text-gray-400 hover:text-white text-3xl font-bold focus:outline-none z-10">×</button>
      <div class="relative" style="padding-bottom: 56.25%;"><iframe id="video-player" class="absolute top-0 left-0 w-full h-full rounded-lg" src="" frameborder="0" allow="autoplay; fullscreen; picture-in-picture" allowfullscreen></iframe></div>
    </div>
  </div>
</div>

<script>
  // --- START OF CONFIGURATION ---
  const STORED_PASSCODE_HASH = "ad90de1520fb30637f3734f9b03140a1abd6dcb3dd922c0684b9f57b3da08861"; // ❗ REPLACE THIS
  const CLIENT_ID = '82608849356-u1c59ugg5dijbn0vjnpoubibhcfbccuc.apps.googleusercontent.com'; // ❗ REPLACE THIS
  const API_KEY = ''; // Google API Key (Optional) ❗ REPLACE THIS
  const GOOGLE_DRIVE_FOLDER_ID = '1lMS61TWY60Fqt6aQ3tNQIr82VSzISOLL'; // ❗ REPLACE THIS

  // ❗❗ WARNING: TMDb API KEY WILL BE EXPOSED IN CLIENT-SIDE CODE ❗❗
  const TMDB_API_KEY = '96940be4c3047db623024860a4d18ade'; // Your TMDb API Key

  const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];
  const SCOPES = 'https://www.googleapis.com/auth/drive.readonly';
  // --- END OF CONFIGURATION ---

  let gapiInited = false;
  let gisInited = false;
  let tokenClient;
  let gapi;
  let gis;
  let googleDriveFilesWithTMDbMeta = [];

  // DOM Elements
  const appContentEl = document.getElementById('app-content');
  const heroSection = document.getElementById('hero-section');
  const heroBackground = document.getElementById('hero-background');
  const heroTitle = document.getElementById('hero-title');
  const heroMeta = document.getElementById('hero-meta');
  const heroSynopsisShort = document.getElementById('hero-synopsis-short');
  const heroPlayButton = document.getElementById('hero-play-button');
  const videoCategoriesContainer = document.getElementById('video-categories-container');
  const dashboardView = document.getElementById('dashboard-view');
  const movieDetailView = document.getElementById('movie-detail-view');
  const detailPoster = document.getElementById('detail-poster');
  const detailTitle = document.getElementById('detail-title');
  const detailYear = document.getElementById('detail-year');
  const detailType = document.getElementById('detail-type');
  const detailDuration = document.getElementById('detail-duration');
  const detailSynopsis = document.getElementById('detail-synopsis');
  const detailPlayButton = document.getElementById('detail-play-button');
  const detailCastList = document.getElementById('detail-cast-list');
  const detailRatings = document.getElementById('detail-ratings');
  const detailRelatedSection = document.getElementById('detail-related-section');
  const backToDashboardButton = document.getElementById('back-to-dashboard');
  const videoModal = document.getElementById('video-modal');
  const closeModalButton = document.getElementById('close-modal');
  const videoPlayer = document.getElementById('video-player');
  const passcodeSectionEl = document.getElementById('passcode-section');
  const authStatusContainerEl = document.getElementById('auth-status-container');
  const passcodeSubmitButtonEl = document.getElementById('passcode-submit-button');
  const passcodeErrorEl = document.getElementById('passcode-error-message');
  const passcodeInputField = document.getElementById('passcode-input-field');
  const authorizeButton = document.getElementById('authorize_button');
  const statusMessage = document.getElementById('status-message');
  const loadingSpinner = document.getElementById('loading-spinner');
  const errorMessage = document.getElementById('error-message');

  // --- UI Functions ---
  function showView(viewId) { /* ... (same as provided before) ... */
    document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
    const viewToShow = document.getElementById(viewId);
    if (viewToShow) viewToShow.classList.add('active'); else console.error("View not found:", viewId);
    window.scrollTo(0,0); // Scroll to top when view changes
  }

  function showLoadingState(isLoading, message = "Loading...") { /* ... (same as provided before) ... */
    if (isLoading) {
      loadingSpinner.classList.remove('hidden');
      statusMessage.textContent = message;
      statusMessage.classList.remove('hidden');
      authStatusContainerEl.style.display = 'flex'; // Show the auth container for loading
    } else {
      loadingSpinner.classList.add('hidden');
      // Only hide auth container if it was shown for loading AND no other error is present
      if (authStatusContainerEl.style.display === 'flex' && errorMessage.classList.contains('hidden')) {
        authStatusContainerEl.style.display = 'none';
      }
      statusMessage.classList.add('hidden');
    }
  }
  function showGlobalError(message) { /* ... (same as provided before) ... */
    errorMessage.textContent = message;
    errorMessage.classList.remove('hidden');
    authStatusContainerEl.style.display = 'flex'; // Show container for error
    loadingSpinner.classList.add('hidden'); // Hide spinner if error shown
  }

  // --- Passcode Logic ---
  async function verifyPasscode() { /* ... (same as provided before, on success, show authStatusContainerEl) ... */
    const enteredPasscode = passcodeInputField.value;
    passcodeErrorEl.classList.add('hidden');
    if (!enteredPasscode) { passcodeErrorEl.textContent = 'Passcode cannot be empty.'; passcodeErrorEl.classList.remove('hidden'); return; }
    if (STORED_PASSCODE_HASH === "YOUR_PRE_CALCULATED_SHA256_HASH_HERE") { passcodeErrorEl.textContent = 'Dev: Passcode hash not set!'; passcodeErrorEl.classList.remove('hidden'); return;}
    try {
      const buffer = new TextEncoder().encode(enteredPasscode);
      const hashBuffer = await crypto.subtle.digest('SHA-256', buffer);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      const enteredPasscodeHash = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
      if (enteredPasscodeHash === STORED_PASSCODE_HASH) {
        passcodeSectionEl.style.display = 'none';
        authStatusContainerEl.style.display = 'flex';
        if (gapiInited && gisInited) maybeEnableAuthButton();
      } else {
        passcodeErrorEl.textContent = 'Invalid passcode.'; passcodeErrorEl.classList.remove('hidden');
        passcodeInputField.focus(); passcodeInputField.select();
      }
    } catch (error) { console.error("Passcode hash error:", error); passcodeErrorEl.textContent = 'Error processing passcode.'; passcodeErrorEl.classList.remove('hidden'); }
  }
  passcodeSubmitButtonEl.addEventListener('click', verifyPasscode);
  passcodeInputField.addEventListener('keypress', (e) => { if (e.key === "Enter") { e.preventDefault(); verifyPasscode(); }});

  // --- Google API & Auth Logic ---
  function gapiLoaded() { gapi = window.gapi; gapi.load('client', initializeGapiClient); }
  async function initializeGapiClient() { /* ... (same, on success calls maybeEnableAuthButton) ... */
    try { await gapi.client.init({ apiKey: API_KEY, discoveryDocs: DISCOVERY_DOCS }); gapiInited = true; maybeEnableAuthButton(); }
    catch (error) { console.error("GAPI client init error:", error); showGlobalError("Error initializing Google API."); }
  }
  function gisLoaded() { /* ... (same, on success calls maybeEnableAuthButton) ... */
    gis = window.google.accounts.oauth2;
    try { tokenClient = gis.initTokenClient({ client_id: CLIENT_ID, scope: SCOPES, callback: '' }); gisInited = true; maybeEnableAuthButton(); }
    catch (error) { console.error("GIS client init error:", error); showGlobalError("Error initializing Google Sign-In."); }
  }
  function maybeEnableAuthButton() { /* ... (same, enables authorize_button if authStatusContainerEl is visible) ... */
    if (authStatusContainerEl.style.display === 'none' || authStatusContainerEl.style.display === '') return;
    if (gapiInited && gisInited) {
      authorizeButton.onclick = handleAuthClick;
      statusMessage.textContent = 'Ready to sign in.';
      authorizeButton.disabled = false;
      loadingSpinner.classList.add('hidden');
    } else {
      loadingSpinner.classList.remove('hidden');
      statusMessage.textContent = 'Initializing authentication...';
      authorizeButton.disabled = true;
    }
  }
  function handleAuthClick() { /* ... (same, on success calls listDriveVideos) ... */
    if (!tokenClient) { showGlobalError("Auth client not ready."); return; }
    tokenClient.callback = async (resp) => {
      if (resp.error) {
        console.error('Auth Error:', resp.error);
        let errMsg = 'Failed to sign in. ' + (resp.error_description || resp.error);
        showGlobalError(errMsg); authorizeButton.textContent = 'Sign In'; authorizeButton.disabled = false; loadingSpinner.classList.add('hidden');
        return;
      }
      authStatusContainerEl.style.display = 'none'; // Hide auth section
      appContentEl.style.display = 'block';      // Show main app
      await listDriveVideos();                   // Fetch Drive files and then TMDb data
    };
    if (gapi.client.getToken() === null) tokenClient.requestAccessToken({prompt: 'consent'});
    else tokenClient.requestAccessToken({prompt: ''});
  }

  // --- TMDb Fetching Logic ---
  async function fetchTMDbDetailsForMovie(movieNameFromDrive, driveFileId) { /* ... (same as in previous "direct fetch" example) ... */
    console.log(`Fetching TMDb for: "${movieNameFromDrive}" (Drive ID: ${driveFileId})`);
    const fallbackMeta = (errMsg = "Metadata fetch failed.") => ({
      driveFileId: driveFileId, title: movieNameFromDrive.split(/\b(19|20)\d{2}\b/)[0].trim() || movieNameFromDrive, // Try to get title before year
      year: null, type: "Movie", categories: ["Uncategorized"], posterUrl: `https://placehold.co/300x450/1f2937/4b5563?text=${encodeURIComponent(movieNameFromDrive)}`,
      heroImageUrl: null, synopsis: errMsg, cast: [], ratings: {}, duration: null, director: null, isFallback: true
    });
    try {
      const searchUrl = `https://api.themoviedb.org/3/search/movie?api_key=${TMDB_API_KEY}&query=${encodeURIComponent(movieNameFromDrive)}`;
      const searchResponse = await fetch(searchUrl);
      if (!searchResponse.ok) { console.error(`TMDb Search Error for ${movieNameFromDrive}: ${searchResponse.status}`); return fallbackMeta(`Search failed: ${searchResponse.status}`);}
      const searchData = await searchResponse.json();
      if (!searchData.results || searchData.results.length === 0) { console.warn(`No TMDb results for ${movieNameFromDrive}`); return fallbackMeta("No TMDb match found."); }
      const tmdbMovie = searchData.results[0];

      const detailsUrl = `https://api.themoviedb.org/3/movie/${tmdbMovie.id}?api_key=${TMDB_API_KEY}&append_to_response=credits,images`;
      const detailsResponse = await fetch(detailsUrl);
      if (!detailsResponse.ok) { console.error(`TMDb Details Error for ${tmdbMovie.title}: ${detailsResponse.status}`);
        return { ...fallbackMeta(`Details fetch failed: ${detailsResponse.status}`), title: tmdbMovie.title || movieNameFromDrive, posterUrl: tmdbMovie.poster_path ? `https://image.tmdb.org/t/p/w500${tmdbMovie.poster_path}` : fallbackMeta().posterUrl };
      }
      const d = await detailsResponse.json(); // detailsData
      return {
        driveFileId: driveFileId, title: d.title, year: d.release_date ? parseInt(d.release_date.substring(0, 4)) : null,
        type: "Movie", categories: d.genres ? d.genres.map(g => g.name) : [],
        posterUrl: d.poster_path ? `https://image.tmdb.org/t/p/w500${d.poster_path}` : fallbackMeta().posterUrl,
        heroImageUrl: d.backdrop_path ? `https://image.tmdb.org/t/p/original${d.backdrop_path}` : null,
        synopsis: d.overview,
        cast: d.credits?.cast?.slice(0, 5).map(c => ({ name: c.name, character: c.character })) || [],
        ratings: { tmdb_vote_average: d.vote_average?.toFixed(1), tmdb_vote_count: d.vote_count },
        duration: d.runtime ? `${Math.floor(d.runtime / 60)}h ${d.runtime % 60}m` : null,
        director: d.credits?.crew?.find(c => c.job === "Director")?.name || null, isFallback: false
      };
    } catch (error) { console.error(`General error in fetchTMDbDetailsForMovie for "${movieNameFromDrive}":`, error); return fallbackMeta("Network or script error during fetch."); }
  }

  // --- Main Data Loading & UI Population ---
  async function listDriveVideos() { /* ... (same as in previous "direct fetch" example, calls fetchTMDbDetailsForMovie for each file) ... */
    showLoadingState(true, "Loading video library & details...");
    googleDriveFilesWithTMDbMeta = [];
    try {
      const response = await gapi.client.drive.files.list({
        q: `'${GOOGLE_DRIVE_FOLDER_ID}' in parents and mimeType contains 'video/' and trashed = false`,
        fields: 'files(id, name, webViewLink, description, thumbnailLink)', pageSize: 100,
      });
      const filesFromDrive = response.result.files;
      if (filesFromDrive && filesFromDrive.length > 0) {
        const promises = filesFromDrive.map(async (driveFile) => {
          let movieSearchTerm = driveFile.name.replace(/\.(mkv|mp4|avi|mov|wmv)$/i, '').replace(/\./g, ' ').trim(); // Remove common extensions and replace dots
          const yearMatch = movieSearchTerm.match(/(.*?)(\b(19|20)\d{2}\b)/); // Try to get "Name YEAR"
          if (yearMatch && yearMatch[1] && yearMatch[2]) movieSearchTerm = yearMatch[1].trim() + " " + yearMatch[2];
          else movieSearchTerm = movieSearchTerm.replace(/\b(1080p|720p|4k|BluRay|WEB-DL|x264|x265|DTS|AAC|HDR|SDR|REMASTERED|EXTENDED|UNCUT)\b/gi, '').replace(/\s+/g, ' ').trim(); // Clean up quality tags if no year pattern

          const tmdbMeta = await fetchTMDbDetailsForMovie(movieSearchTerm, driveFile.id);
          await new Promise(resolve => setTimeout(resolve, 400 + Math.random() * 200)); // TMDb Rate limit delay
          return { driveData: driveFile, meta: tmdbMeta };
        });
        const results = await Promise.all(promises);
        googleDriveFilesWithTMDbMeta = results.filter(r => r && r.meta);
        if (googleDriveFilesWithTMDbMeta.length > 0) {
          populateDashboard(googleDriveFilesWithTMDbMeta);
          setupEventListeners(googleDriveFilesWithTMDbMeta);
        } else { videoCategoriesContainer.innerHTML = '<p class="text-center text-gray-400 text-xl">No videos found or metadata could not be fetched.</p>'; }
      } else { videoCategoriesContainer.innerHTML = '<p class="text-center text-gray-400 text-xl">No videos in Google Drive folder.</p>'; }
    } catch (err) { console.error('Error in listDriveVideos:', err); showGlobalError('Error loading videos: ' + (err.result?.error?.message || err.message || "")); }
    finally { showLoadingState(false); }
  }

  function populateDashboard(videosToDisplay) { /* ... (same as provided before, using videosToDisplay) ... */
    const featuredVideo = videosToDisplay.find(v => v.meta && !v.meta.isFallback && v.meta.heroImageUrl) || videosToDisplay.find(v => v.meta && !v.meta.isFallback) || videosToDisplay[0];
    if (featuredVideo && featuredVideo.meta) {
      heroBackground.style.backgroundImage = `url('${featuredVideo.meta.heroImageUrl || featuredVideo.meta.posterUrl}')`;
      heroTitle.textContent = featuredVideo.meta.title;
      heroMeta.textContent = `${featuredVideo.meta.type || 'Movie'} ${featuredVideo.meta.year ? '· ' + featuredVideo.meta.year : ''}`;
      heroSynopsisShort.textContent = featuredVideo.meta.synopsis;
      heroPlayButton.onclick = () => playVideo(featuredVideo);
      heroSection.style.display = 'flex';
    } else { heroSection.style.display = 'none'; }

    videoCategoriesContainer.innerHTML = '';
    const categories = {};
    videosToDisplay.forEach(video => {
      const catsToUse = video.meta.isFallback ? ["Uncategorized"] : (video.meta.categories || ["General"]);
      catsToUse.forEach(catName => {
        if (!categories[catName]) categories[catName] = [];
        categories[catName].push(video);
      });
    });
    const categoryOrder = ["Featured", "My List", "Action", "Thriller", "Comedy", "Science Fiction", "Animation", "Drama", "Horror", "Adventure", "Fantasy", "Kids", "General", "Uncategorized"]; // Define preferred order
    const sortedCategoryNames = Object.keys(categories).sort((a, b) => {
      const indexA = categoryOrder.indexOf(a); const indexB = categoryOrder.indexOf(b);
      if (indexA === -1 && indexB === -1) return a.localeCompare(b); if (indexA === -1) return 1; if (indexB === -1) return -1; return indexA - indexB;
    });

    sortedCategoryNames.forEach(catName => {
      if (!categories[catName] || categories[catName].length === 0) return;
      const catSection = document.createElement('section');
      catSection.className = 'category-section';
      catSection.innerHTML = `<h2 class="text-2xl font-semibold text-white mb-4">${catName}</h2>
                    <div class="horizontal-scroll flex space-x-3 md:space-x-4 overflow-x-auto pb-4 -mb-4">
                        ${categories[catName].map(video => createVideoPosterCard(video)).join('')}
                    </div>`;
      videoCategoriesContainer.appendChild(catSection);
    });
  }
  function createVideoPosterCard(videoData) { /* ... (same as provided before) ... */
    const title = videoData.meta.title || videoData.driveData.name;
    const poster = videoData.meta.posterUrl || videoData.driveData.thumbnailLink || `https://placehold.co/300x450/1f2937/4b5563?text=${encodeURIComponent(title.substring(0,20))}`;
    return `<div class="video-poster-card bg-gray-800 rounded-lg overflow-hidden shadow-lg transform hover:scale-105 transition-transform duration-200 cursor-pointer w-36 md:w-48 flex-shrink-0" data-drive-id="${videoData.driveData.id}">
                        <img src="${poster}" alt="${title}" class="w-full h-auto object-cover aspect-[2/3]" onerror="this.src='https://placehold.co/300x450/1f2937/4b5563?text=No+Poster';">
                    </div>`;
  }
  function populateMovieDetailView(videoData) { /* ... (same as provided before, check for videoData.meta.isFallback for display) ... */
    if (!videoData || !videoData.meta) { console.error("Detail view: Missing data"); showView('dashboard-view'); return; }
    detailPoster.src = videoData.meta.posterUrl || `https://placehold.co/500x750/1f2937/4b5563?text=No+Poster`;
    detailPoster.alt = videoData.meta.title;
    detailTitle.textContent = videoData.meta.title;
    detailYear.textContent = videoData.meta.year || '';
    detailType.textContent = videoData.meta.type || 'Movie';
    detailDuration.textContent = videoData.meta.duration || '';

    document.querySelectorAll('#detail-meta-info .detail-bullet').forEach(el => el.style.display = 'none');
    let prevVisible = false;
    [detailYear, detailType, detailDuration].forEach((el, index) => {
      const bullet = el.nextElementSibling;
      if (el.textContent) {
        if (prevVisible && bullet && bullet.classList.contains('detail-bullet')) bullet.style.display = 'inline';
        prevVisible = true;
      } else { prevVisible = false;}
    });

    detailSynopsis.textContent = videoData.meta.synopsis || "No synopsis available.";
    detailPlayButton.onclick = () => playVideo(videoData);
    detailCastList.innerHTML = videoData.meta.cast && videoData.meta.cast.length > 0 ? videoData.meta.cast.map(m => `<li>${m.name} ${m.character ? `(as ${m.character})` : ''}</li>`).join('') : '<li>Cast information not available.</li>';
    detailRatings.innerHTML = videoData.meta.ratings && videoData.meta.ratings.tmdb_vote_average ? `<div class="flex items-center"><strong class="text-white mr-1">TMDb:</strong> ${videoData.meta.ratings.tmdb_vote_average}/10 (${videoData.meta.ratings.tmdb_vote_count} votes)</div>` : '<span>Ratings not available.</span>';

    // Populate related (simplified: show other items from "Uncategorized" or first available genre if not fallback)
    detailRelatedSection.innerHTML = '';
    const primaryCategoryForRelated = videoData.meta.isFallback ? "Uncategorized" : (videoData.meta.categories && videoData.meta.categories[0]) || "General";
    const relatedVideos = googleDriveFilesWithTMDbMeta.filter(v => v.driveData.id !== videoData.driveData.id && v.meta && (v.meta.isFallback && primaryCategoryForRelated === "Uncategorized" || v.meta.categories?.includes(primaryCategoryForRelated))).slice(0,10);
    if(relatedVideos.length > 0) {
      const section = document.createElement('section');
      section.innerHTML = `<h2 class="text-2xl font-semibold text-white mb-4">More Like This</h2>
                    <div class="horizontal-scroll flex space-x-3 md:space-x-4 overflow-x-auto pb-4 -mb-4">
                        ${relatedVideos.map(video => createVideoPosterCard(video)).join('')}
                    </div>`;
      detailRelatedSection.appendChild(section);
    }
    showView('movie-detail-view');
  }
  function playVideo(videoData) { /* ... (same as provided before, uses videoData.driveData.webViewLink) ... */
    const embedUrl = videoData.driveData.webViewLink.replace("/view", "/preview").replace("usp=sharing", "usp=embed_googleplus");
    videoPlayer.src = embedUrl; videoModal.classList.remove('hidden'); document.body.style.overflow = 'hidden';
  }
  function closeVideoPlayerModal() { /* ... (same) ... */
    videoModal.classList.add('hidden'); videoPlayer.src = ''; document.body.style.overflow = '';
  }

  // --- Event Listeners ---
  function setupEventListeners(videosForEvents) { /* ... (same as provided before, uses videosForEvents) ... */
    document.querySelectorAll('.nav-link[data-view="dashboard-view"]').forEach(link => {
      link.addEventListener('click', (e) => { e.preventDefault(); showView('dashboard-view'); });
    });
    document.body.addEventListener('click', (e) => {
      const card = e.target.closest('.video-poster-card');
      if (card) {
        const driveId = card.dataset.driveId;
        const selectedVideo = videosForEvents.find(v => v.driveData.id === driveId);
        if (selectedVideo) populateMovieDetailView(selectedVideo);
      }
    });
    backToDashboardButton.addEventListener('click', () => showView('dashboard-view'));
    closeModalButton.addEventListener('click', closeVideoPlayerModal);
    videoModal.addEventListener('click', (e) => { if (e.target === videoModal) closeVideoPlayerModal(); });
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape' && !videoModal.classList.contains('hidden')) closeVideoPlayerModal();});
  }

  // Initial view
  showView('dashboard-view'); // Start on dashboard, will be empty until data loads
</script>

<!-- Google API Loader Scripts -->
<script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
<script>
  function loadGisClientInternal() {
    const scriptTag = document.createElement('script');
    scriptTag.src = 'https://accounts.google.com/gsi/client';
    scriptTag.async = true; scriptTag.defer = true;
    scriptTag.onload = function() { if (typeof gisLoaded === 'function') gisLoaded(); else console.error("gisLoaded not defined."); };
    scriptTag.onerror = function() { console.error("Failed to load GIS client."); showGlobalError("Failed to load Sign-In component.");};
    document.head.appendChild(scriptTag);
  }
  loadGisClientInternal();
</script>
</body>
</html>
