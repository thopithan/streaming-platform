<!DOCTYPE html>
<html lang="en" class="bg-gray-900 text-gray-200">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Streaming Service (meta.json Sync)</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>
  <style>
    body { font-family: 'Inter', sans-serif; }
    .horizontal-scroll::-webkit-scrollbar { height: 8px; }
    .horizontal-scroll::-webkit-scrollbar-thumb { background-color: #4a5568; border-radius: 10px;}
    .hero-gradient { background: linear-gradient(to top, rgba(17,24,39,1) 5%, rgba(17,24,39,0.7) 20%, rgba(17,24,39,0) 50%); }
    .text-shadow { text-shadow: 0px 2px 4px rgba(0,0,0,0.5); }
    #passcode-section, #auth-status-container { /* Styles to center them achieved with Tailwind */ }
    #app-content { display: none; }
    .view { display: none; }
    .view.active { display: block; }
    .animate-spin { animation: spin 1s linear infinite; } /* For spinner */
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
  </style>
</head>
<body class="bg-gray-900">

<!-- Passcode Section -->
<div id="passcode-section" class="fixed inset-0 z-[100] bg-gray-900 flex flex-col items-center justify-center p-4 sm:p-8">
  <div class="bg-gray-800 p-6 sm:p-8 rounded-xl shadow-xl border border-gray-700 w-full max-w-md">
    <!-- Lottie Animation - REPLACE THE SRC URL -->
    <div class="mx-auto mb-6 w-32 h-32 sm:w-40 sm:h-40">
      <lottie-player src="login-animation.json" background="transparent" speed="1" loop autoplay></lottie-player>
    </div>
    <h2 class="text-2xl font-bold text-white mb-6 text-center">Enter Passcode</h2>
    <input type="password" id="passcode-input-field" class="w-full bg-gray-700 text-white px-4 py-3 mb-4 border border-gray-600 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 outline-none" placeholder="Passcode" autocomplete="off">
    <button id="passcode-submit-button" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg shadow-md focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-opacity-75 transition duration-300 ease-in-out">
      Access
    </button>
    <p id="passcode-error-message" class="text-red-400 mt-3 text-sm hidden text-center">Invalid passcode.</p>
  </div>
</div>

<!-- Google Auth & Loading Section -->
<div id="auth-status-container" class="fixed inset-0 z-[90] bg-gray-900 flex-col items-center justify-center p-4 sm:p-8 hidden">
  <div id="auth-status" class="bg-gray-800 p-6 sm:p-8 rounded-xl shadow-xl border border-gray-700 w-full max-w-md flex flex-col items-center">
    <p id="status-message" class="text-lg text-gray-300 mb-4 text-center">Please sign in to view your videos.</p>
    <button id="authorize_button" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg shadow-md focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-opacity-75 transition duration-300 ease-in-out" disabled>
      Sign In with Google
    </button>
    <div id="loading-spinner" class="hidden mt-4 w-12 h-12 border-4 border-gray-600 border-t-purple-500 border-solid rounded-full animate-spin"></div>
    <div id="progress-indicator" class="w-full mt-4 hidden">
      <p id="progress-message" class="text-sm text-gray-400 mb-1 text-center">Initializing...</p>
      <div class="w-full bg-gray-700 rounded-full h-2.5">
        <div id="progress-bar" class="bg-purple-600 h-2.5 rounded-full" style="width: 0%"></div>
      </div>
      <p id="progress-percentage" class="text-center text-xs text-gray-400 mt-1">0%</p>
    </div>
    <p id="error-message" class="text-red-400 mt-4 hidden text-center"></p>
  </div>
</div>

<!-- Main App Content -->
<div id="app-content" class="min-h-screen">
  <!-- Navbar -->
  <nav class="fixed top-0 left-0 right-0 z-50 bg-gray-900 bg-opacity-80 backdrop-blur-md p-4 shadow-lg">
    <div class="container mx-auto flex items-center justify-between">
      <div class="text-2xl font-bold text-white">MYFLIX</div>
      <div class="hidden md:flex items-center space-x-6">
        <a href="#" class="text-gray-300 hover:text-white nav-link" data-view="dashboard-view">DASHBOARD</a>
      </div>
      <div class="flex items-center space-x-2 sm:space-x-4">
        <button id="download-meta-button" class="hidden bg-blue-500 hover:bg-blue-600 text-white text-xs sm:text-sm py-2 px-2 sm:px-3 rounded-md">Download meta.json</button>
        <button class="text-gray-300 hover:text-white p-1 sm:p-0"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg></button>
        <button class="text-gray-300 hover:text-white p-1 sm:p-0"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg></button>
      </div>
    </div>
  </nav>

  <!-- Dashboard View / Homepage -->
  <div id="dashboard-view" class="view active pt-20">
    <section id="hero-section" class="relative h-[60vh] sm:h-[70vh] min-h-[350px] sm:min-h-[400px] w-full flex items-end p-4 sm:p-8 md:p-16 text-white">
      <div id="hero-background" class="absolute inset-0 bg-cover bg-center"></div>
      <div class="absolute inset-0 hero-gradient"></div>
      <div class="relative z-10 max-w-xl">
        <h1 id="hero-title" class="text-3xl sm:text-4xl md:text-6xl font-bold mb-2 sm:mb-4 text-shadow"></h1>
        <p id="hero-meta" class="text-base sm:text-lg mb-1 sm:mb-2 text-shadow"></p>
        <p id="hero-synopsis-short" class="text-sm sm:text-md mb-4 sm:mb-6 text-shadow line-clamp-2 sm:line-clamp-3"></p>
        <div class="flex space-x-2 sm:space-x-4">
          <button id="hero-play-button" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 sm:py-3 sm:px-8 rounded-md text-base sm:text-lg">PLAY</button>
          <button id="hero-add-list-button" class="bg-gray-700 bg-opacity-70 hover:bg-gray-600 text-white p-2 sm:p-3 rounded-md border border-gray-500">
            <svg class="w-5 h-5 sm:w-6 sm:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
          </button>
        </div>
      </div>
    </section>
    <div id="video-categories-container" class="container mx-auto px-4 py-8 space-y-8 sm:space-y-10">
      <!-- Categories will be dynamically inserted here -->
    </div>
  </div>

  <!-- Movie Detail View -->
  <div id="movie-detail-view" class="view container mx-auto px-4 py-8 pt-24 space-y-8 sm:space-y-10">
    <button id="back-to-dashboard" class="mb-4 sm:mb-6 text-purple-400 hover:text-purple-300 flex items-center">
      <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
      Back to Dashboard
    </button>
    <div class="flex flex-col md:flex-row gap-6 sm:gap-8">
      <div class="w-full md:w-1/3 flex-shrink-0">
        <img id="detail-poster" src="" alt="Movie Poster" class="rounded-lg shadow-xl w-full max-w-xs mx-auto md:max-w-none">
      </div>
      <div class="md:w-2/3 text-gray-300">
        <h1 id="detail-title" class="text-3xl sm:text-4xl md:text-5xl font-bold text-white mb-2 sm:mb-3"></h1>
        <div id="detail-meta-info" class="flex flex-wrap items-center space-x-1 text-sm sm:text-base text-gray-400 mb-3 sm:mb-4">
          <span id="detail-year"></span><span class="detail-bullet mx-1" style="display:none;">•</span>
          <span id="detail-type"></span><span class="detail-bullet mx-1" style="display:none;">•</span>
          <span id="detail-duration"></span>
        </div>
        <p id="detail-synopsis" class="mb-4 sm:mb-6 text-base sm:text-lg leading-relaxed"></p>
        <button id="detail-play-button" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-6 sm:py-3 sm:px-10 rounded-md text-base sm:text-lg mb-6 sm:mb-8">PLAY VIDEO</button>
        <div class="mb-4 sm:mb-6"><h3 class="text-lg sm:text-xl font-semibold text-white mb-1 sm:mb-2">Cast</h3><ul id="detail-cast-list" class="list-none space-y-1 text-sm sm:text-base text-gray-400"></ul></div>
        <div><h3 class="text-lg sm:text-xl font-semibold text-white mb-1 sm:mb-2">Ratings</h3><div id="detail-ratings" class="flex flex-wrap space-x-2 sm:space-x-4 text-sm sm:text-base text-gray-400"></div></div>
      </div>
    </div>
    <section id="detail-related-section" class="pt-6 sm:pt-10"></section>
  </div>

  <!-- Video Player Modal (Used for Desktop) -->
  <div id="video-modal" class="fixed inset-0 z-[1000] hidden flex items-center justify-center bg-black bg-opacity-80 p-2 sm:p-4">
    <div class="relative bg-gray-800 rounded-xl shadow-2xl p-1 md:p-2 w-full max-w-4xl max-h-[90vh] overflow-hidden">
      <button id="close-modal" class="absolute top-2 right-2 md:top-3 md:right-3 text-gray-400 hover:text-white text-3xl font-bold focus:outline-none z-10">×</button>
      <div class="relative" style="padding-bottom: 56.25%;">
        <iframe id="video-player" class="absolute top-0 left-0 w-full h-full rounded-lg" src="" frameborder="0"
                allow="autoplay; fullscreen; picture-in-picture"
                allowfullscreen
                webkitallowfullscreen
                mozallowfullscreen></iframe>
      </div>
    </div>
  </div>
</div>

<script>
  // --- START OF CONFIGURATION ---
  const STORED_PASSCODE_HASH = "ad90de1520fb30637f3734f9b03140a1abd6dcb3dd922c0684b9f57b3da08861"; // ❗ SHA256 of "password". REPLACE THIS with hash of your actual passcode.
  const DEFAULT_DEV_PASSCODE_HASH = "ad90de1520fb30637f3734f9b03240a1abd6dcb3dd922c0684b9f57b4da08861"; // Used to warn if default is still set
  const CLIENT_ID = '82608849356-u1c59ugg5dijbn0vjnpoubibhcfbccuc.apps.googleusercontent.com'; // ❗ REPLACE THIS with your Google OAuth Client ID
  const API_KEY = ''; // Google API Key (Usually optional if using OAuth for all calls) ❗ REPLACE THIS if needed
  const GOOGLE_DRIVE_FOLDER_ID = '1lMS61TWY60Fqt6aQ3tNQIr82VSzISOLL'; // ❗ REPLACE THIS with your Google Drive Folder ID
  const TMDB_API_KEY = '96940be4c3047db623024860a4d18ade'; // ❗ REPLACE THIS with your TMDb API Key (v3 auth)
  const META_JSON_URL = './meta.json'; // ❗ URL to your meta.json file. Place it in the same directory or provide a full URL.

  const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];
  const SCOPES = 'https://www.googleapis.com/auth/drive.readonly';
  // --- END OF CONFIGURATION ---

  let gapiInited = false;
  let gisInited = false;
  let tokenClient;
  let gapi;
  let gis;
  let googleDriveFilesWithTMDbMeta = [];
  let allDriveFilesRaw = [];

  // DOM Elements
  const appContentEl = document.getElementById('app-content');
  const heroSection = document.getElementById('hero-section');
  const heroBackground = document.getElementById('hero-background');
  const heroTitle = document.getElementById('hero-title');
  const heroMeta = document.getElementById('hero-meta');
  const heroSynopsisShort = document.getElementById('hero-synopsis-short');
  const heroPlayButton = document.getElementById('hero-play-button');
  const videoCategoriesContainer = document.getElementById('video-categories-container');
  const dashboardView = document.getElementById('dashboard-view');
  const movieDetailView = document.getElementById('movie-detail-view');
  const detailPoster = document.getElementById('detail-poster');
  const detailTitle = document.getElementById('detail-title');
  const detailYear = document.getElementById('detail-year');
  const detailType = document.getElementById('detail-type');
  const detailDuration = document.getElementById('detail-duration');
  const detailSynopsis = document.getElementById('detail-synopsis');
  const detailPlayButton = document.getElementById('detail-play-button');
  const detailCastList = document.getElementById('detail-cast-list');
  const detailRatings = document.getElementById('detail-ratings');
  const detailRelatedSection = document.getElementById('detail-related-section');
  const backToDashboardButton = document.getElementById('back-to-dashboard');
  const videoModal = document.getElementById('video-modal');
  const closeModalButton = document.getElementById('close-modal');
  const videoPlayer = document.getElementById('video-player');
  const passcodeSectionEl = document.getElementById('passcode-section');
  const authStatusContainerEl = document.getElementById('auth-status-container');
  const passcodeSubmitButtonEl = document.getElementById('passcode-submit-button');
  const passcodeErrorEl = document.getElementById('passcode-error-message');
  const passcodeInputField = document.getElementById('passcode-input-field');
  const authorizeButton = document.getElementById('authorize_button');
  const statusMessage = document.getElementById('status-message');
  const loadingSpinner = document.getElementById('loading-spinner');
  const errorMessage = document.getElementById('error-message');
  const progressIndicatorEl = document.getElementById('progress-indicator');
  const progressMessageEl = document.getElementById('progress-message');
  const progressBarEl = document.getElementById('progress-bar');
  const progressPercentageEl = document.getElementById('progress-percentage');
  const downloadMetaButtonEl = document.getElementById('download-meta-button');

  // --- UI Functions ---
  function showView(viewId) {
    document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
    const viewToShow = document.getElementById(viewId);
    if (viewToShow) viewToShow.classList.add('active'); else console.error("View not found:", viewId);
    window.scrollTo(0,0);
  }

  function updateProgress(percentage, message) {
    if (progressIndicatorEl && !progressIndicatorEl.classList.contains('hidden')) {
      progressBarEl.style.width = `${Math.max(0, Math.min(100, percentage))}%`;
      progressPercentageEl.textContent = `${Math.round(percentage)}%`;
      if (message) progressMessageEl.textContent = message;
    }
  }

  function showLoadingState(isLoading, message = "Loading...") {
    if (isLoading) {
      loadingSpinner.classList.remove('hidden');
      statusMessage.textContent = message;
      statusMessage.classList.remove('hidden');
      progressIndicatorEl.classList.remove('hidden');
      updateProgress(0, message);
      authStatusContainerEl.style.display = 'flex';
      appContentEl.style.display = 'none';
    } else {
      loadingSpinner.classList.add('hidden');
      progressIndicatorEl.classList.add('hidden');
      if (authStatusContainerEl.style.display === 'flex' && errorMessage.classList.contains('hidden')) {
        authStatusContainerEl.style.display = 'none';
      }
      statusMessage.classList.add('hidden');
      if (authStatusContainerEl.style.display === 'none') {
        appContentEl.style.display = 'block';
      }
    }
  }

  function showGlobalError(message) {
    errorMessage.textContent = message;
    errorMessage.classList.remove('hidden');
    authStatusContainerEl.style.display = 'flex';
    loadingSpinner.classList.add('hidden');
    progressIndicatorEl.classList.add('hidden');
    appContentEl.style.display = 'none';
  }

  // --- Passcode Logic ---
  async function verifyPasscode() {
    const enteredPasscode = passcodeInputField.value;
    passcodeErrorEl.classList.add('hidden');
    if (!enteredPasscode) { passcodeErrorEl.textContent = 'Passcode cannot be empty.'; passcodeErrorEl.classList.remove('hidden'); return; }

    // This warning logic might be slightly off from original intent if STORED_PASSCODE_HASH was changed
    // from the "password" example but DEFAULT_DEV_PASSCODE_HASH wasn't updated to match it.
    // The primary check is that STORED_PASSCODE_HASH should not be the common "password" hash.
    // The provided hashes are not for "password", so this warning should be fine unless they are truly a default.
    if (STORED_PASSCODE_HASH === DEFAULT_DEV_PASSCODE_HASH) {
      passcodeErrorEl.textContent = 'Developer: Default passcode hash is in use. Please change STORED_PASSCODE_HASH.';
      passcodeErrorEl.classList.remove('hidden');
    }
    try {
      const buffer = new TextEncoder().encode(enteredPasscode);
      const hashBuffer = await crypto.subtle.digest('SHA-256', buffer);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      const enteredPasscodeHash = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
      if (enteredPasscodeHash === STORED_PASSCODE_HASH) {
        passcodeSectionEl.style.display = 'none';
        authStatusContainerEl.style.display = 'flex';
        if (gapiInited && gisInited) maybeEnableAuthButton();
        else showLoadingState(true, 'Initializing authentication...');
      } else {
        passcodeErrorEl.textContent = 'Invalid passcode.'; passcodeErrorEl.classList.remove('hidden');
        passcodeInputField.focus(); passcodeInputField.select();
      }
    } catch (error) { console.error("Passcode hash error:", error); passcodeErrorEl.textContent = 'Error processing passcode.'; passcodeErrorEl.classList.remove('hidden'); }
  }
  passcodeSubmitButtonEl.addEventListener('click', verifyPasscode);
  passcodeInputField.addEventListener('keypress', (e) => { if (e.key === "Enter") { e.preventDefault(); verifyPasscode(); }});

  // --- Google API & Auth Logic ---
  function gapiLoaded() { gapi = window.gapi; gapi.load('client', initializeGapiClient); }
  async function initializeGapiClient() {
    try { await gapi.client.init({ apiKey: API_KEY, discoveryDocs: DISCOVERY_DOCS }); gapiInited = true; maybeEnableAuthButton(); }
    catch (error) { console.error("GAPI client init error:", error); showGlobalError("Error initializing Google API."); }
  }
  function gisLoaded() {
    gis = window.google.accounts.oauth2;
    try { tokenClient = gis.initTokenClient({ client_id: CLIENT_ID, scope: SCOPES, callback: '' }); gisInited = true; maybeEnableAuthButton(); }
    catch (error) { console.error("GIS client init error:", error); showGlobalError("Error initializing Google Sign-In."); }
  }
  function maybeEnableAuthButton() {
    if (authStatusContainerEl.style.display === 'none' || authStatusContainerEl.style.display === '') return;
    if (gapiInited && gisInited) {
      authorizeButton.onclick = handleAuthClick;
      statusMessage.textContent = 'Ready to sign in.';
      authorizeButton.disabled = false;
      loadingSpinner.classList.add('hidden');
      if (progressMessageEl.textContent.startsWith('Initializing authentication')) {
        progressIndicatorEl.classList.add('hidden');
      }
    } else {
      if (!loadingSpinner.classList.contains('hidden')) {
        statusMessage.textContent = 'Initializing authentication components...';
        updateProgress(0, 'Initializing authentication components...');
      }
    }
  }

  function handleAuthClick() {
    if (!tokenClient) { showGlobalError("Auth client not ready."); return; }
    tokenClient.callback = async (resp) => {
      if (resp.error) {
        console.error('Auth Error:', resp.error);
        let errMsg = 'Failed to sign in. ' + (resp.error_description || resp.error);
        showGlobalError(errMsg); authorizeButton.textContent = 'Sign In'; authorizeButton.disabled = false; loadingSpinner.classList.add('hidden');
        return;
      }
      downloadMetaButtonEl.classList.remove('hidden');
      await loadAndSynchronizeData();
    };
    if (gapi.client.getToken() === null) tokenClient.requestAccessToken({prompt: 'consent'});
    else tokenClient.requestAccessToken({prompt: ''});
  }

  // --- TMDb Fetching Logic ---
  async function fetchTMDbDetailsForMovie(movieNameFromDrive, driveFileId) {
    const cleanNameForSearch = movieNameFromDrive
            .replace(/\.(mkv|mp4|avi|mov|wmv|flv|webm)$/i, '')
            .replace(/[._\-\+]/g, ' ')
            .replace(/\b(1080p|720p|4k|2160p|480p|360p|HD|SD|BluRay|BRRip|BDRip|WEB-DL|WEBRip|HDRip|DVDRip|HDTV|PDTV|DSR|SATRip|SCR|CAM|TS|TC|PPVRip)\b/gi, '')
            .replace(/\b(x264|x265|h264|h265|HEVC|XviD|DivX)\b/gi, '')
            .replace(/\b(AAC|AC3|DTS|TrueHD|Atmos|FLAC|MP3)\b/gi, '')
            .replace(/\b(5\.1|7\.1|2\.0|DUAL AUDIO|MULTI)\b/gi, '')
            .replace(/\b(HDR|SDR|EXTENDED|UNCUT|REMASTERED|DIRECTORS CUT|FINAL CUT|PROPER|REPACK|INTERNAL|LIMITED|COMPLETE|SUBBED|DUBBED|READNFO)\b/gi, '')
            .replace(/\[.*?\]/g, '')
            .replace(/\(.*?\)/g, '')
            .replace(/\s{2,}/g, ' ')
            .trim();

    let searchName = cleanNameForSearch;
    const yearMatch = movieNameFromDrive.match(/\b(19\d{2}|20\d{2})\b/);
    let yearForSearch = yearMatch ? yearMatch[0] : null;

    if (!yearForSearch) {
      const cleanNameYearMatch = cleanNameForSearch.match(/\b(19\d{2}|20\d{2})\b/);
      if (cleanNameYearMatch) {
        yearForSearch = cleanNameYearMatch[0];
        searchName = cleanNameForSearch.replace(yearForSearch, '').trim();
      }
    } else {
      searchName = cleanNameForSearch.replace(yearForSearch, '').trim();
    }
    searchName = searchName.replace(/\b(19\d{2}|20\d{2})\b/g, '').trim();

    const fallbackMeta = (errMsg = "Metadata fetch failed.") => ({
      driveFileId: driveFileId,
      driveFileName: movieNameFromDrive,
      title: searchName || movieNameFromDrive.split(/\.(mkv|mp4|avi|mov|wmv)/i)[0].trim(),
      year: yearForSearch ? parseInt(yearForSearch) : null,
      type: "Movie", categories: ["Uncategorized"],
      posterUrl: `https://placehold.co/300x450/1f2937/4b5563?text=${encodeURIComponent((searchName || movieNameFromDrive).substring(0,15))}`,
      heroImageUrl: null, synopsis: errMsg, cast: [], ratings: {}, duration: null, director: null,
      isFallback: true, lastUpdated: new Date().toISOString(), tmdbId: null
    });

    if (!TMDB_API_KEY) return fallbackMeta("TMDb API Key not configured.");
    if (!searchName) return fallbackMeta("Could not determine a valid search name.");

    try {
      let searchUrl = `https://api.themoviedb.org/3/search/movie?api_key=${TMDB_API_KEY}&query=${encodeURIComponent(searchName)}`;
      if (yearForSearch) searchUrl += `&year=${yearForSearch}`;

      const searchResponse = await fetch(searchUrl);
      if (!searchResponse.ok) { console.error(`TMDb Search Error for ${searchName}: ${searchResponse.status}`); return fallbackMeta(`Search failed: ${searchResponse.status}`); }
      const searchData = await searchResponse.json();

      let tmdbMovie;
      if (searchData.results && searchData.results.length > 0) {
        tmdbMovie = searchData.results[0];
      } else {
        console.warn(`No TMDb results for "${searchName}" (Year: ${yearForSearch || 'N/A'}).`);
        return fallbackMeta("No TMDb match found.");
      }

      const detailsUrl = `https://api.themoviedb.org/3/movie/${tmdbMovie.id}?api_key=${TMDB_API_KEY}&append_to_response=credits,images`;
      const detailsResponse = await fetch(detailsUrl);
      if (!detailsResponse.ok) {
        console.error(`TMDb Details Error for ${tmdbMovie.title}: ${detailsResponse.status}`);
        return { ...fallbackMeta(`Details fetch failed: ${detailsResponse.status}`), title: tmdbMovie.title || searchName, posterUrl: tmdbMovie.poster_path ? `https://image.tmdb.org/t/p/w500${tmdbMovie.poster_path}` : fallbackMeta().posterUrl };
      }
      const d = await detailsResponse.json();
      return {
        driveFileId: driveFileId,
        driveFileName: movieNameFromDrive,
        title: d.title, year: d.release_date ? parseInt(d.release_date.substring(0, 4)) : null,
        type: "Movie", categories: d.genres && d.genres.length > 0 ? d.genres.map(g => g.name) : ["Uncategorized"],
        posterUrl: d.poster_path ? `https://image.tmdb.org/t/p/w500${d.poster_path}` : fallbackMeta().posterUrl,
        heroImageUrl: d.backdrop_path ? `https://image.tmdb.org/t/p/original${d.backdrop_path}` : (d.poster_path ? `https://image.tmdb.org/t/p/w1280${d.poster_path}`: null),
        synopsis: d.overview,
        cast: d.credits?.cast?.slice(0, 10).map(c => ({ name: c.name, character: c.character })) || [],
        ratings: { tmdb_vote_average: d.vote_average?.toFixed(1), tmdb_vote_count: d.vote_count },
        duration: d.runtime ? `${Math.floor(d.runtime / 60)}h ${d.runtime % 60}m` : null,
        director: d.credits?.crew?.find(c => c.job === "Director")?.name || null,
        isFallback: false,
        lastUpdated: new Date().toISOString(),
        tmdbId: d.id
      };
    } catch (error) { console.error(`General error in fetchTMDbDetailsForMovie for "${searchName}":`, error); return fallbackMeta("Network or script error during fetch."); }
  }

  // --- Main Data Loading and Synchronization ---
  async function loadAndSynchronizeData() {
    showLoadingState(true, "Starting data synchronization...");
    googleDriveFilesWithTMDbMeta = [];
    allDriveFilesRaw = [];
    let currentProgress = 0;
    const totalProgressPhases = 4;
    const progressPerPhase = 100 / totalProgressPhases;

    updateProgress(currentProgress, "Fetching local metadata (meta.json)...");
    let localMeta = [];
    try {
      const response = await fetch(META_JSON_URL + `?t=${new Date().getTime()}`);
      if (response.ok) {
        localMeta = await response.json();
        if (!Array.isArray(localMeta)) { localMeta = []; console.warn("meta.json was not a valid array."); }
      } else { console.warn(`meta.json not found or error (status: ${response.status}). Will build new.`); }
    } catch (error) { console.warn("Error fetching meta.json:", error); }
    currentProgress += progressPerPhase;
    updateProgress(currentProgress, "Local metadata processed.");

    updateProgress(currentProgress, "Fetching video list from Google Drive...");
    try {
      const response = await gapi.client.drive.files.list({
        q: `'${GOOGLE_DRIVE_FOLDER_ID}' in parents and (mimeType contains 'video/' or mimeType = 'application/octet-stream') and trashed = false`,
        fields: 'files(id, name, webViewLink, description, thumbnailLink, createdTime, modifiedTime)',
        pageSize: 500,
        orderBy: 'name'
      });
      allDriveFilesRaw = response.result.files || [];
    } catch (err) {
      console.error('Error listing Drive files:', err);
      showGlobalError('Error loading files from Drive: ' + (err.result?.error?.message || err.message || "Unknown error"));
      showLoadingState(false);
      return;
    }
    currentProgress += progressPerPhase;
    updateProgress(currentProgress, `${allDriveFilesRaw.length} item(s) found in Drive folder.`);

    if (allDriveFilesRaw.length === 0 && localMeta.length === 0) {
      videoCategoriesContainer.innerHTML = '<p class="text-center text-gray-400 text-xl">No videos found in Drive or local metadata.</p>';
      showLoadingState(false);
      appContentEl.style.display = 'block';
      populateDashboard([]);
      setupEventListeners([]);
      return;
    }

    updateProgress(currentProgress, "Synchronizing metadata...");
    const driveFileIdsInDrive = new Set(allDriveFilesRaw.map(f => f.id));
    const finalMetaData = [];
    let filesToFetchTMDbFor = [];

    for (const metaEntry of localMeta) {
      if (driveFileIdsInDrive.has(metaEntry.driveFileId)) {
        const driveFile = allDriveFilesRaw.find(df => df.id === metaEntry.driveFileId);
        const updatedEntry = { ...metaEntry };
        if (driveFile) {
          updatedEntry.driveFileName = driveFile.name;
          updatedEntry.webViewLink = driveFile.webViewLink;
        }
        finalMetaData.push(updatedEntry);
      }
    }

    const finalMetaDataIds = new Set(finalMetaData.map(m => m.driveFileId));
    for (const driveFile of allDriveFilesRaw) {
      if (!finalMetaDataIds.has(driveFile.id)) {
        filesToFetchTMDbFor.push(driveFile);
      }
    }
    currentProgress += progressPerPhase;
    updateProgress(currentProgress, `Synchronization logic complete. ${filesToFetchTMDbFor.length} new items to process.`);

    if (filesToFetchTMDbFor.length > 0) {
      const tmdbProgressStart = currentProgress;
      const progressPerTMDbFetch = filesToFetchTMDbFor.length > 0 ? (100 - tmdbProgressStart) / filesToFetchTMDbFor.length : 0;
      let fetchedCount = 0;

      for (const driveFile of filesToFetchTMDbFor) {
        updateProgress(tmdbProgressStart + (fetchedCount * progressPerTMDbFetch), `Fetching metadata for: ${driveFile.name}`);
        const tmdbMeta = await fetchTMDbDetailsForMovie(driveFile.name, driveFile.id);
        finalMetaData.push({ ...tmdbMeta, webViewLink: driveFile.webViewLink });
        fetchedCount++;
        await new Promise(resolve => setTimeout(resolve, 350));
      }
    }
    googleDriveFilesWithTMDbMeta = finalMetaData.sort((a,b) => (a.title || a.driveFileName).localeCompare(b.title || b.driveFileName));

    updateProgress(100, "Synchronization complete!");
    await new Promise(resolve => setTimeout(resolve, 500));
    showLoadingState(false);

    if (googleDriveFilesWithTMDbMeta.length > 0) {
      populateDashboard(googleDriveFilesWithTMDbMeta);
      setupEventListeners(googleDriveFilesWithTMDbMeta);
    } else {
      videoCategoriesContainer.innerHTML = '<p class="text-center text-gray-400 text-xl">No videos available after synchronization.</p>';
      populateDashboard([]);
      setupEventListeners([]);
    }
  }

  // --- Data Population & UI ---
  function populateDashboard(videosToDisplay) {
    const featuredVideo = videosToDisplay.find(v => !v.isFallback && v.heroImageUrl) ||
            videosToDisplay.find(v => !v.isFallback) ||
            (videosToDisplay.length > 0 ? videosToDisplay[0] : null);

    if (featuredVideo) {
      heroBackground.style.backgroundImage = `url('${featuredVideo.heroImageUrl || featuredVideo.posterUrl}')`;
      heroTitle.textContent = featuredVideo.title;
      heroMeta.textContent = `${featuredVideo.type || 'Movie'} ${featuredVideo.year ? '· ' + featuredVideo.year : ''}`;
      heroSynopsisShort.textContent = featuredVideo.synopsis;
      heroPlayButton.onclick = () => playVideo(featuredVideo);
      heroSection.style.display = 'flex';
    } else {
      heroSection.style.display = 'none';
    }

    videoCategoriesContainer.innerHTML = '';
    if (videosToDisplay.length === 0) {
      videoCategoriesContainer.innerHTML = '<p class="text-center text-gray-400 text-xl mt-10">Your library is currently empty.</p>';
      return;
    }

    const categories = {};
    videosToDisplay.forEach(videoMeta => {
      const catsToUse = videoMeta.isFallback ? ["Uncategorized"] : (videoMeta.categories && videoMeta.categories.length > 0 ? videoMeta.categories : ["General"]);
      catsToUse.forEach(catName => {
        if (!categories[catName]) categories[catName] = [];
        categories[catName].push(videoMeta);
      });
    });

    const categoryOrder = ["Action", "Adventure", "Animation", "Comedy", "Crime", "Documentary", "Drama", "Family", "Fantasy", "History", "Horror", "Music", "Mystery", "Romance", "Science Fiction", "TV Movie", "Thriller", "War", "Western", "General", "Uncategorized"];
    const sortedCategoryNames = Object.keys(categories).sort((a, b) => {
      const indexA = categoryOrder.indexOf(a); const indexB = categoryOrder.indexOf(b);
      if (indexA === -1 && indexB === -1) return a.localeCompare(b); if (indexA === -1) return 1; if (indexB === -1) return -1; return indexA - indexB;
    });

    sortedCategoryNames.forEach(catName => {
      if (!categories[catName] || categories[catName].length === 0) return;
      const catSection = document.createElement('section');
      catSection.className = 'category-section';
      catSection.innerHTML = `<h2 class="text-2xl font-semibold text-white mb-3 sm:mb-4">${catName}</h2>
                        <div class="horizontal-scroll flex space-x-3 md:space-x-4 overflow-x-auto pb-4 -mb-4">
                            ${categories[catName].map(videoMeta => createVideoPosterCard(videoMeta)).join('')}
                        </div>`;
      videoCategoriesContainer.appendChild(catSection);
    });
  }

  function createVideoPosterCard(videoMeta) {
    const title = videoMeta.title || videoMeta.driveFileName;
    const poster = videoMeta.posterUrl || `https://placehold.co/300x450/1f2937/4b5563?text=${encodeURIComponent(title.substring(0,20))}`;
    return `<div class="video-poster-card bg-gray-800 rounded-lg overflow-hidden shadow-lg transform hover:scale-105 transition-transform duration-200 cursor-pointer w-32 sm:w-36 md:w-48 flex-shrink-0" data-drive-id="${videoMeta.driveFileId}">
              <img src="${poster}" alt="${title}" class="w-full h-auto object-cover aspect-[2/3]" onerror="this.src='https://placehold.co/300x450/1f2937/4b5563?text=No+Poster'; this.onerror=null;">
            </div>`;
  }

  function populateMovieDetailView(videoMeta) {
    if (!videoMeta) { console.error("Detail view: Missing data"); showView('dashboard-view'); return; }
    detailPoster.src = videoMeta.posterUrl || `https://placehold.co/500x750/1f2937/4b5563?text=No+Poster`;
    detailPoster.alt = videoMeta.title;
    detailTitle.textContent = videoMeta.title;
    detailYear.textContent = videoMeta.year || '';
    detailType.textContent = videoMeta.type || (videoMeta.categories && videoMeta.categories.includes("TV Movie") ? "TV Movie" : "Movie");
    detailDuration.textContent = videoMeta.duration || '';

    const metaSpans = [detailYear, detailType, detailDuration];
    const metaBullets = Array.from(document.querySelectorAll('#detail-meta-info .detail-bullet'));
    metaBullets.forEach(bullet => bullet.style.display = 'none');
    let lastVisibleSpanIndex = -1;
    for (let i = 0; i < metaSpans.length; i++) {
      if (metaSpans[i].textContent && metaSpans[i].textContent.trim() !== '') {
        metaSpans[i].style.display = 'inline';
        if (lastVisibleSpanIndex !== -1 && metaBullets[lastVisibleSpanIndex]) {
          metaBullets[lastVisibleSpanIndex].style.display = 'inline';
        }
        lastVisibleSpanIndex = i;
      } else {
        metaSpans[i].style.display = 'none';
      }
    }

    detailSynopsis.textContent = videoMeta.synopsis || "No synopsis available.";
    detailPlayButton.onclick = () => playVideo(videoMeta);
    detailCastList.innerHTML = videoMeta.cast && videoMeta.cast.length > 0 ? videoMeta.cast.map(m => `<li>${m.name} ${m.character ? `<span class="text-gray-500">as ${m.character}</span>` : ''}</li>`).join('') : '<li>Cast information not available.</li>';
    detailRatings.innerHTML = videoMeta.ratings && videoMeta.ratings.tmdb_vote_average ? `<div class="flex items-center"><strong class="text-white mr-1">TMDb:</strong> ${videoMeta.ratings.tmdb_vote_average}/10 <span class="text-gray-500 ml-1">(${videoMeta.ratings.tmdb_vote_count} votes)</span></div>` : '<span>Ratings not available.</span>';

    detailRelatedSection.innerHTML = '';
    const primaryCategoryForRelated = videoMeta.isFallback ? "Uncategorized" : (videoMeta.categories && videoMeta.categories.length > 0 && videoMeta.categories[0]) || "General";
    const relatedVideos = googleDriveFilesWithTMDbMeta.filter(v =>
            v.driveFileId !== videoMeta.driveFileId &&
            ( (v.isFallback && primaryCategoryForRelated === "Uncategorized") ||
                    (v.categories && v.categories.includes(primaryCategoryForRelated)) )
    ).slice(0,8); // Show fewer related on mobile to avoid too much scrolling

    if(relatedVideos.length > 0) {
      const section = document.createElement('section');
      section.innerHTML = `<h2 class="text-xl sm:text-2xl font-semibold text-white mb-3 sm:mb-4">More Like This</h2>
                    <div class="horizontal-scroll flex space-x-3 md:space-x-4 overflow-x-auto pb-4 -mb-4">
                        ${relatedVideos.map(video => createVideoPosterCard(video)).join('')}
                    </div>`;
      detailRelatedSection.appendChild(section);
    }
    showView('movie-detail-view');
  }

  // Helper function to detect mobile devices
  function isMobileDevice() {
    return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
  }

  function playVideo(videoMeta) {
    const webViewLink = videoMeta.webViewLink;
    if (!webViewLink) {
      console.error("webViewLink is missing for video:", videoMeta.title);
      alert("Video link is missing. Cannot play.");
      return;
    }

    if (isMobileDevice()) {
      // For all mobile devices, open the Google Drive webViewLink in a new tab.
      const newTab = window.open(webViewLink, '_blank');
      if (newTab) {
        newTab.focus();
      } else {
        alert("Could not open video in a new tab. Please check your pop-up blocker settings. Link: " + webViewLink);
      }
      return;
    }

    // For non-mobile (desktop) browsers, use the embedded player in the modal
    const embedUrl = webViewLink.replace("/view", "/preview").replace("usp=sharing", "usp=embed_googleplus");
    videoPlayer.src = embedUrl;
    videoModal.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
  }

  function closeVideoPlayerModal() {
    videoModal.classList.add('hidden'); videoPlayer.src = ''; document.body.style.overflow = '';
  }

  // --- Event Listeners ---
  function setupEventListeners(videosForEvents) {
    document.querySelectorAll('.nav-link[data-view="dashboard-view"]').forEach(link => {
      link.addEventListener('click', (e) => { e.preventDefault(); showView('dashboard-view'); });
    });
    document.body.addEventListener('click', (e) => {
      const card = e.target.closest('.video-poster-card');
      if (card) {
        const driveId = card.dataset.driveId;
        const selectedVideo = googleDriveFilesWithTMDbMeta.find(v => v.driveFileId === driveId);
        if (selectedVideo) populateMovieDetailView(selectedVideo);
      }
    });
    backToDashboardButton.addEventListener('click', () => showView('dashboard-view'));

    closeModalButton.addEventListener('click', closeVideoPlayerModal);
    videoModal.addEventListener('click', (e) => { if (e.target === videoModal) closeVideoPlayerModal(); });
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && !videoModal.classList.contains('hidden')) {
        closeVideoPlayerModal();
      }
    });
    downloadMetaButtonEl.addEventListener('click', downloadUpdatedMetaJson);
  }

  // --- Download meta.json ---
  function downloadUpdatedMetaJson() {
    if (googleDriveFilesWithTMDbMeta.length === 0) {
      alert("No metadata to download. Library is empty.");
      return;
    }
    const dataToSave = googleDriveFilesWithTMDbMeta.map(item => ({
      driveFileId: item.driveFileId,
      driveFileName: item.driveFileName,
      webViewLink: item.webViewLink,
      title: item.title,
      year: item.year,
      type: item.type,
      categories: item.categories,
      posterUrl: item.posterUrl,
      heroImageUrl: item.heroImageUrl,
      synopsis: item.synopsis,
      cast: item.cast,
      ratings: item.ratings,
      duration: item.duration,
      director: item.director,
      isFallback: item.isFallback,
      lastUpdated: new Date().toISOString(),
      tmdbId: item.tmdbId
    }));

    const jsonData = JSON.stringify(dataToSave, null, 2);
    const blob = new Blob([jsonData], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'meta.json';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    alert("meta.json prepared. Please save it and replace the one in your project folder.");
  }

  // Initial setup
  if (passcodeSectionEl) passcodeSectionEl.style.display = 'flex';
  showView('dashboard-view');
</script>

<!-- Google API Loader Scripts -->
<script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
<script>
  function loadGisClientInternal() {
    const scriptTag = document.createElement('script');
    scriptTag.src = 'https://accounts.google.com/gsi/client';
    scriptTag.async = true; scriptTag.defer = true;
    scriptTag.onload = function() { if (typeof gisLoaded === 'function') gisLoaded(); else console.error("gisLoaded not defined."); };
    scriptTag.onerror = function() { console.error("Failed to load GIS client."); showGlobalError("Failed to load Sign-In component.");};
    document.head.appendChild(scriptTag);
  }
  loadGisClientInternal();
</script>
</body>
</html>
